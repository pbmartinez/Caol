@page "/comercial-performance"
@using Application.Dtos
@using Domain.DataAnnotations
@using BlazorApp.Shared.Components
@using BlazorApp.Models
@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions

@inject HttpClient Http
@inject IStringLocalizer<Resource> Localizer
@inject ISnackbar Snackbar

<MudGrid>
    <MudItem xs="12">
        <MudPaper Class="pa-4">
            <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors" >
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker Label="Inicio" @bind-Date="filterOptions.StartDate" FixDay=1 Required="true" RequiredError="Start Date is required!" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker Label="Fin" @bind-Date="filterOptions.EndDate" FixDay=1 Required="true" RequiredError="End Date is required!"
                                       Validation="@(new Func<DateTime?, IEnumerable<string>>(CompareDates))" 
                                       />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        @if (Usuarios != null && Usuarios.Count > 0)
                        {
                            <MudSelect T="string"
                                   Label="Vendedor"
                                   MultiSelection="true" @bind-Value="filterOptions.SelectedValues" @bind-SelectedValues="options"
                                   Clearable="true"
                                   SelectAll="true"
                                   Placeholder="Select vendor ..."
                                   Dense="true"
                                   Required="true"
                                   RequiredError="Must select at least one vendor !">
                                @foreach (var item in Usuarios)
                                {
                                    <MudSelectItem T="string" Value="@item.CoUsuario">@item.NoUsuario</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudSelect T="string"></MudSelect>
                        }
                    </MudItem>
                </MudGrid>

                <div class="d-flex align-center justify-space-between mt-6">
                    <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Disabled="@(!success)" OnClick="ShowPizzaAsync" Class="ml-auto" 
                               StartIcon="@Icons.Material.Filled.PieChart" > Show Pizza </MudButton>
                    <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Disabled="@(!success)" OnClick="ShowGraphicAsync" Class="ml-auto"
                               StartIcon="@Icons.Material.Filled.BarChart"> Show Graphic </MudButton>
                    <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" Disabled="@(!success)" OnClick="ShowRelatorioAsync" Class="ml-auto"
                               StartIcon="@Icons.Material.Filled.TableRows"> Show Relatorio </MudButton>                    
                </div>
            </MudForm>
        </MudPaper>
    </MudItem>
</MudGrid>




<MudGrid>
    @if (Aporte != null && Aporte.Valores != null && Aporte.Valores.Count != 0)
    {
        <MudItem xs="12" sm="6">
            <PieChart Aporte=Aporte></PieChart>
        </MudItem>
    }
    @if (UserPerformance != null && UserPerformance.UsuarioRecetas != null && UserPerformance.UsuarioRecetas.Count != 0)
    {
        <MudItem xs="12" sm="6">
            <GraphicChart UsuarioPerformance=UserPerformance></GraphicChart>
        </MudItem>
    }
    @if (UsuariosRelatorio != null && UsuariosRelatorio.Count > 0)
    {
        <MudItem xs="12">
            <RelatorioTable Usuarios=UsuariosRelatorio></RelatorioTable>
        </MudItem>
    }
</MudGrid>
@code {

    bool success;
    string[] errors = { };
    MudTextField<string> pwField1;
    MudForm form;

    private IEnumerable<string> options { get; set; } = new HashSet<string>();

    private string value { get; set; } = "Nothing selected";
    DateTime? StartDate;
    DateTime? EndDate;
    FilterOptions filterOptions; 
    List<CaoUsuarioDto> Usuarios = new List<CaoUsuarioDto>();
    AporteRecetaLiquidaDto? Aporte = null;
    AporteMensualDto? UserPerformance = null;
    List<UsuarioDto> UsuariosRelatorio = new List<UsuarioDto>();

    protected override async Task OnInitializedAsync()
    {
        StartDate = DateTime.Today.AddDays(-DateTime.Today.Day + 1);
        EndDate = DateTime.Today.AddDays(-DateTime.Today.Day + 1).AddMonths(1);
        filterOptions = new FilterOptions
            {
                StartDate = StartDate,
                EndDate = EndDate,
                SelectedValues = string.Empty
            };
        var us = await Http.GetFromJsonAsync<List<CaoUsuarioDto>>("api/usuarios");
        Usuarios = us ?? new List<CaoUsuarioDto>();
    }

    private string ForApiEndPoint(DateTime? date)
    {
        if (date == null)
        {
            return string.Empty;
        }
        return $"{date?.Year}-{date?.Month}-{date?.Day}";
    }
    private async Task ShowPizzaAsync()
    {
        var link = $"api/facturas/pizza?startDate={ForApiEndPoint(filterOptions.StartDate)}&endDate={ForApiEndPoint(filterOptions.EndDate)}&coUsuarios={string.Join(',', options)}";
        var distroAporte = await Http.GetFromJsonAsync<AporteRecetaLiquidaDto>(link);
        if (distroAporte == null || distroAporte.Total == 0 || distroAporte.Valores.Count == 0)
        {
            Snackbar.Add("No results", Severity.Info);
        }
        else
            Aporte = distroAporte;
    }
    private async Task ShowGraphicAsync()
    {
        //var link = $"api/facturas/graphic?startDate={ForApiEndPoint(StartDate)}&endDate={ForApiEndPoint(EndDate)}&coUsuarios={string.Join(',', options)}";
        var link = $"api/facturas/graphic?startDate=2007-01-01&endDate=2007-12-01&coUsuarios=carlos.carvalho,carlos.arruda,anapaula.chiodaro";
        var aporteMensualDto = await Http.GetFromJsonAsync<AporteMensualDto>(link);
        if (aporteMensualDto == null || aporteMensualDto.UsuarioRecetas.Count == 0 || aporteMensualDto.UsuarioRecetas.Count == 0)
        {
            Snackbar.Add("No results", Severity.Info);
        }
        else
            UserPerformance = aporteMensualDto;
    }
    private async Task ShowRelatorioAsync()
    {
        //var link = $"api/facturas/relatorio?startDate={ForApiEndPoint(StartDate)}&endDate={ForApiEndPoint(EndDate)}&coUsuarios={string.Join(',', options)}";
        var link = $"api/facturas/relatorio?startDate=2007-01-01&endDate=2007-12-01&coUsuarios=carlos.carvalho,carlos.arruda,anapaula.chiodaro";
        var listaUsuarios = await Http.GetFromJsonAsync<List<UsuarioDto>>(link);
        if (listaUsuarios == null || listaUsuarios.Count == 0)
        {
            Snackbar.Add("No results", Severity.Info);
        }
        else
            UsuariosRelatorio = listaUsuarios;
    }
    private List<string> CompareDates(DateTime? endDate)
    {
        var listOfErrors = new List<string>();
        if (endDate?.Date <= filterOptions.StartDate?.Date)
            listOfErrors.Add("EndDate must be greated then start date");
        return listOfErrors;
    }
}

